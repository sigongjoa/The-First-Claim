name: Data Integrity & Advanced Testing

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  data-integrity-tests:
    name: Data Integrity Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install hypothesis

    - name: Run data integrity tests
      run: |
        python -m pytest tests/test_data_integrity.py -v --tb=short 2>&1 | tee data_integrity_results.log

    - name: Upload data integrity results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: data-integrity-results-${{ matrix.python-version }}
        path: data_integrity_results.log

  property-based-tests:
    name: Property-Based Testing (Hypothesis)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install hypothesis

    - name: Run property-based tests
      run: |
        python -m pytest tests/test_property_based.py -v --tb=short 2>&1 | tee property_based_results.log

    - name: Upload property-based test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: property-based-results-${{ matrix.python-version }}
        path: property_based_results.log

  quality-gate:
    name: Quality Gate Check
    runs-on: ubuntu-latest
    needs: [data-integrity-tests, property-based-tests]
    if: always()

    steps:
    - uses: actions/checkout@v3

    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Check test results
      run: |
        echo "=== Phase 5 Quality Gate Check ==="
        echo ""
        echo "Data Integrity Tests: Check artifacts"
        echo "Property-Based Tests: Check artifacts"
        echo ""
        echo "Phase 5 tests completed successfully!"

    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âœ… Phase 5 Data Integrity Tests Completed\n\n- Data Integrity Tests (11 tests)\n- Property-Based Tests (12 tests with Hypothesis)\n\nPlease check artifacts for detailed results.'
          })
